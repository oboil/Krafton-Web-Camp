<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>배틀그라운드 전적 검색</title>

    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 50px;
      }
      input {
        margin: 5px;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .loading {
        text-align: center;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <input type="text" name="" id="nickname" placeholder="닉네임" />
    <input type="text" name="" id="platform" placeholder="플랫폼" />
    <button onclick="search()">검색</button>
    <div id="info"></div>

    <script>
      function search(params) {
        const playerName = document.getElementById("nickname").value;
        const platform = document.getElementById("platform").value;

        $("#info").empty();

        $("#info").append(`<div class="loading">
            <div class="spinner"></div>
            <p>플레이어 검색 중...</p>
            </div>`);

        $.ajax({
          type: "GET",
          url: `https://api.pubg.com/shards/${platform}/players?filter[playerNames]=${playerName}`,
          headers: {
            Authorization: "API KEY",
            Accept: "application/vnd.api+json",
          },
          success: function (response) {
            $("#info").empty();

            const playerId = response.data[0].id;
            console.log(playerId);

            $("#info").append(`<div class="loading">
            <div class="spinner"></div>
            <p>전적 불러오는 중...</p>
            </div>`);

            $.ajax({
              type: "GET",
              url: `https://api.pubg.com/shards/${platform}/players/${playerId}/seasons/lifetime?filter[gamepad]=false`,
              headers: {
                Authorization: "API KEY",
                Accept: "application/vnd.api+json",
              },
              success: function (response) {
                $("#info").empty();

                const gameModeStatus = response.data.attributes.gameModeStats;

                const modes = ["solo", "duo", "squad"];
                let statsHtml = `<h2>${platform} 유저 ${playerName} 님의 전적</h2>`;

                let totalRounds = 0,
                  totalWins = 0,
                  totalLosses = 0,
                  totalKills = 0,
                  totalDeaths = 0,
                  totalSurvivalTime = 0;

                modes.forEach((mode) => {
                  const modeData = gameModeStatus[mode];
                  if (modeData.roundsPlayed > 0) {
                    totalRounds += modeData.roundsPlayed;
                    totalWins += modeData.wins;
                    totalLosses += modeData.losses;
                    totalKills += modeData.kills;
                    totalDeaths += modeData.roundsPlayed - modeData.wins; // 죽은 횟수
                    totalSurvivalTime += modeData.timeSurvived;
                  }
                });
                const totalKdr =
                  totalDeaths > 0
                    ? (totalKills / totalDeaths).toFixed(2)
                    : totalKills;

                const totalAvgSurvivalTime =
                  totalRounds > 0
                    ? (totalSurvivalTime / totalRounds / 60).toFixed(1)
                    : 0; // 분 단위

                statsHtml += `
                  <div class="total-stats">
                    <h3>총 ${totalRounds}경기 ${totalWins}승 ${totalLosses}패<h3>
                    <p>K/D: ${totalKdr} | 평균 생존 시간: ${totalAvgSurvivalTime}분</p>
                  </div>
                `;

                // 각 모드별 상세 통계
                modes.forEach((mode) => {
                  const modeData = gameModeStatus[mode];
                  const roundsPlayed = modeData.roundsPlayed;

                  if (roundsPlayed > 0) {
                    const wins = modeData.wins;
                    const losses = modeData.losses;
                    const kills = modeData.kills;
                    const deaths = roundsPlayed - wins; // 죽은 횟수
                    const kdr =
                      deaths > 0 ? (kills / deaths).toFixed(2) : kills;
                    const winRate = ((wins / roundsPlayed) * 100).toFixed(2);
                    const avgKills = (kills / roundsPlayed).toFixed(2);
                    const avgSurvivalTime = (
                      modeData.timeSurvived /
                      roundsPlayed /
                      60
                    ).toFixed(1);
                  }
                });

                $("#info").append(statsHtml);
              },
              error: function (xhr, status, error) {
                $("#info").append(
                  `<p style="color: red;">API 호출에 실패하였습니다</p>`
                );
              },
            });
          },
          error: function (xhr, status, error) {
            if (xhr.status === 404) {
              $("#info").append(
                `<p style="color: red;">존재하지 않는 플레이어입니다.</p>`
              );
            } else {
              $("#info").append(
                `<p style="color: red;">API 호출에 실패하였습니다.</p>`
              );
            }
          },
        });
      }
    </script>
  </body>
</html>
