<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë°°í‹€ê·¸ë¼ìš´ë“œ ì „ì  ê²€ìƒ‰</title>

    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .mode-stats {
        border: 1px solid #ddd;
        margin: 10px 0;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 5px;
      }
      .total-stats {
        background-color: #e7f3ff;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
      }
      input {
        padding: 8px;
        margin: 5px;
      }
      button {
        padding: 8px 15px;
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <input type="text" name="" id="nickname" placeholder="ë‹‰ë„¤ì„" />
    <input
      type="text"
      name=""
      id="platform"
      placeholder="í”Œë«í¼ (ê¸°ë³¸: steam)"
    />
    <button onclick="search()">ê²€ìƒ‰</button>
    <div id="info"></div>

    <script>
      function search(params) {
        const playerName = document.getElementById("nickname").value;
        const platform = document.getElementById("platform").value || "steam";

        if (!playerName) {
          alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
          return;
        }

        // ë¡œë”© í‘œì‹œ
        $("#info").html(`
          <div class="loading">
            <div class="spinner"></div>
            <p>ğŸ” í”Œë ˆì´ì–´ ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
          </div>
        `);

        $.ajax({
          type: "GET",
          url: `https://api.pubg.com/shards/${platform}/players?filter[playerNames]=${playerName}`,
          headers: {
            Authorization: "API KEY",
            Accept: "application/vnd.api+json",
          },
          success: function (response) {
            $("#info").empty();

            // í”Œë ˆì´ì–´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°
            if (!response.data || response.data.length === 0) {
              $("#info").html(
                `<p style="color: red;">âŒ í”Œë ˆì´ì–´ "${playerName}"ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`
              );
              return;
            }

            const playerId = response.data[0].id;
            console.log(playerId);

            // ì‹œì¦Œ í†µê³„ ë¡œë”© í‘œì‹œ
            $("#info").html(`
              <div class="loading">
                <div class="spinner"></div>
                <p>ğŸ“Š ${playerName}ë‹˜ì˜ ì „ì ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
              </div>
            `);

            $.ajax({
              type: "GET",
              url: `https://api.pubg.com/shards/${platform}/players/${playerId}/seasons/lifetime?filter[gamepad]=false`,
              headers: {
                Authorization: "API KEY",
                Accept: "application/vnd.api+json",
              },
              success: function (response) {
                const gameModeStatus = response.data.attributes.gameModeStats;

                const modes = ["solo", "duo", "squad"];
                let statsHtml = `<h2>${platform} ìœ ì € ${playerName} ë‹˜ì˜ ì „ì </h2>`;

                let totalRounds = 0,
                  totalWins = 0,
                  totalLosses = 0,
                  totalKills = 0,
                  totalDeaths = 0,
                  totalSurvivalTime = 0;

                // ì „ì²´ í†µê³„ ê³„ì‚°
                modes.forEach((mode) => {
                  const modeData = gameModeStatus[mode];
                  if (modeData.roundsPlayed > 0) {
                    totalRounds += modeData.roundsPlayed;
                    totalWins += modeData.wins;
                    totalLosses += modeData.losses;
                    totalKills += modeData.kills;
                    totalDeaths += modeData.roundsPlayed - modeData.wins; // ì£½ì€ íšŸìˆ˜
                    totalSurvivalTime += modeData.timeSurvived; // ì´ ìƒì¡´ ì‹œê°„ (ì´ˆ)
                  }
                });

                // ì „ì²´ í†µê³„ í‘œì‹œ
                const totalWinRate =
                  totalRounds > 0
                    ? ((totalWins / totalRounds) * 100).toFixed(2)
                    : 0;
                const totalKdr =
                  totalDeaths > 0
                    ? (totalKills / totalDeaths).toFixed(2)
                    : totalKills;
                const totalAvgSurvivalTime =
                  totalRounds > 0
                    ? (totalSurvivalTime / totalRounds / 60).toFixed(1)
                    : 0; // ë¶„ ë‹¨ìœ„

                statsHtml += `
                  <div class="total-stats">
                    <h3>ğŸ“Š ì „ì²´ í†µê³„</h3>
                    <p><strong>ì´ ${totalRounds}ê²½ê¸° | ${totalWins}ìŠ¹ ${totalLosses}íŒ¨</strong></p>
                    <p>ìŠ¹ë¥ : ${totalWinRate}% | KDR: ${totalKdr} | ì´ í‚¬: ${totalKills}</p>
                    <p><strong>ì´ í‰ê·  ìƒì¡´ì‹œê°„: ${totalAvgSurvivalTime}ë¶„</strong></p>
                  </div>
                `;

                // ê° ëª¨ë“œë³„ ìƒì„¸ í†µê³„
                modes.forEach((mode) => {
                  const modeData = gameModeStatus[mode];
                  const roundsPlayed = modeData.roundsPlayed;

                  if (roundsPlayed > 0) {
                    const wins = modeData.wins;
                    const losses = modeData.losses;
                    const kills = modeData.kills;
                    const deaths = roundsPlayed - wins; // ì£½ì€ íšŸìˆ˜
                    const kdr =
                      deaths > 0 ? (kills / deaths).toFixed(2) : kills;
                    const winRate = ((wins / roundsPlayed) * 100).toFixed(2);
                    const avgKills = (kills / roundsPlayed).toFixed(2);
                    const top10Rate = (
                      (modeData.top10s / roundsPlayed) *
                      100
                    ).toFixed(2);
                    const avgSurvivalTime = (
                      modeData.timeSurvived /
                      roundsPlayed /
                      60
                    ).toFixed(1); // ë¶„ ë‹¨ìœ„

                    statsHtml += `
                      <div class="mode-stats">
                        <h4>ğŸ® ${mode.toUpperCase()} ëª¨ë“œ</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                          <div>
                            <strong>ê²½ê¸° ìˆ˜:</strong> ${roundsPlayed}<br>
                            <strong>ìŠ¹ë¦¬:</strong> ${wins}ìŠ¹<br>
                            <strong>íŒ¨ë°°:</strong> ${losses}íŒ¨<br>
                            <strong>ìŠ¹ë¥ :</strong> ${winRate}%
                          </div>
                          <div>
                            <strong>í‚¬:</strong> ${kills}<br>
                            <strong>ë°ìŠ¤:</strong> ${deaths}<br>
                            <strong>KDR:</strong> ${kdr}<br>
                            <strong>í‰ê·  í‚¬:</strong> ${avgKills}/ê²Œì„
                          </div>
                          <div>
                            <strong>Top 10:</strong> ${
                              modeData.top10s
                            }íšŒ (${top10Rate}%)<br>
                            <strong>ìµœê³  í‚¬:</strong> ${
                              modeData.roundMostKills
                            }í‚¬<br>
                            <strong>í—¤ë“œìƒ·:</strong> ${
                              modeData.headshotKills
                            }íšŒ<br>
                            <strong>í‰ê·  ìƒì¡´:</strong> ${avgSurvivalTime}ë¶„
                          </div>
                        </div>
                      </div>
                    `;
                  }
                });

                // í”Œë ˆì´í•˜ì§€ ì•Šì€ ëª¨ë“œ ì²´í¬
                const unplayedModes = modes.filter(
                  (mode) => gameModeStatus[mode].roundsPlayed === 0
                );
                if (unplayedModes.length > 0) {
                  statsHtml += `<p style="color: #666; margin-top: 20px;">
                    ë¯¸í”Œë ˆì´ ëª¨ë“œ: ${unplayedModes
                      .map((mode) => mode.toUpperCase())
                      .join(", ")}
                  </p>`;
                }

                $("#info").html(statsHtml);
              },
              error: function (xhr, status, error) {
                console.log("ì‹œì¦Œ í†µê³„ ì—ëŸ¬:", xhr.status, error);
                if (xhr.status === 400) {
                  $("#info").html(
                    `<p style="color: red;">âŒ ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤. í”Œë«í¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>`
                  );
                } else if (xhr.status === 401) {
                  $("#info").html(
                    `<p style="color: red;">ğŸ”‘ API ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</p>`
                  );
                } else if (xhr.status === 404) {
                  $("#info").html(
                    `<p style="color: red;">ğŸ“Š í•´ë‹¹ í”Œë ˆì´ì–´ì˜ ì‹œì¦Œ í†µê³„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`
                  );
                } else if (xhr.status === 429) {
                  $("#info").html(
                    `<p style="color: red;">â° ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>`
                  );
                } else {
                  $("#info").html(
                    `<p style="color: red;">âŒ ì‹œì¦Œ í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error} (${xhr.status})</p>`
                  );
                }
              },
            });
          },
          error: function (xhr, status, error) {
            console.log("í”Œë ˆì´ì–´ ê²€ìƒ‰ ì—ëŸ¬:", xhr.status, error);
            if (xhr.status === 400) {
              $("#info").html(
                `<p style="color: red;">âŒ ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤. ë‹‰ë„¤ì„ê³¼ í”Œë«í¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>`
              );
            } else if (xhr.status === 401) {
              $("#info").html(
                `<p style="color: red;">ğŸ”‘ API ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</p>`
              );
            } else if (xhr.status === 404) {
              $("#info").html(
                `<p style="color: red;">ğŸ‘¤ í”Œë ˆì´ì–´ "${playerName}"ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹‰ë„¤ì„ê³¼ í”Œë«í¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>`
              );
            } else if (xhr.status === 429) {
              $("#info").html(
                `<p style="color: red;">â° ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>`
              );
            } else {
              $("#info").html(
                `<p style="color: red;">âŒ í”Œë ˆì´ì–´ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error} (${xhr.status})</p>`
              );
            }
          },
        });
      }
    </script>
  </body>
</html>
